<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Submit Amount</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 500px;
            margin: 40px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }
        label {
            display: block;
            margin: 15px 0 5px;
            font-weight: 600;
            color: #34495e;
        }
        input, select, .user-id-display { /* Added .user-id-display here */
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        .user-id-display {
            background-color: #ecf0f1; /* Light gray background for display field */
            color: #7f8c8d;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        input[type="submit"] {
            background: #2ecc71;
            color: white;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
            border: none;
            padding: 14px;
            font-size: 1.1rem;
            border-radius: 8px;
            transition: background 0.3s;
        }
        input[type="submit"]:hover {
            background: #27ae60;
        }
        .loading {
            color: #95a5a6;
            font-style: italic;
        }
        .message {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <h2>Submit Item Amount</h2>

    <form id="amountForm" action="/amount" method="post">
        <!-- 1. User ID (Autofilled and Hidden) -->
        <label>User ID (Logged In)</label>
        <div class="user-id-display">
            <span id="user-id-display" class="loading">Loading user ID...</span>
        </div>
        <!-- CRITICAL: This hidden input sends the ID with the form data -->
        <input type="hidden" id="id-hidden" name="id1">

        <!-- 2. Item Dropdown - sends ITEM NAME (string) -->
        <label for="item-select">Select Item</label>
        <select id="item-select" name="item" required>
            <option value="">Loading items...</option>
        </select>

        <!-- 3. Region Dropdown - sends REGION NAME (string) -->
        <label for="region-select">Select Region</label>
        <select id="region-select" name="region" required>
            <option value="">Loading regions...</option>
        </select>

        <!-- 4. Amount -->
        <label for="amount-input">Amount</label>
        <input 
            type="number" 
            id="amount-input" 
            name="amount" 
            placeholder="Enter quantity" 
            min="1" 
            required
        >

        <!-- Submit -->
        <input type="submit" value="Submit Amount">
    </form>

    <div id="message" class="message"></div>
</div>

<script>
    const messageDiv = document.getElementById('message');
    
    /**
     * Displays a success or error message.
     * @param {string} text - The message text.
     * @param {string} type - 'success' or 'error'.
     */
    function displayMessage(text, type) {
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
    }

    // Load Items - value = item name (string)
    async function loadItems() {
        try {
            const res = await fetch('/items');
            if (!res.ok) throw new Error('Failed to load items list.');
            const items = await res.json();

            const select = document.getElementById('item-select');
            select.innerHTML = '<option value="">Select an item</option>';

            items.forEach(i => {
                const opt = new Option(i.item, i.item);  // value = name, text = name
                select.add(opt);
            });
        } catch (err) {
            document.getElementById('item-select').innerHTML = '<option value="">Failed to load items</option>';
            displayMessage('Failed to load items. Check server log.', 'error');
            console.error(err);
        }
    }

    // Load Regions - value = region name
    async function loadRegions() {
        try {
            const res = await fetch('/locations');
            if (!res.ok) throw new Error('Failed to load regions list.');
            const regions = await res.json();

            const select = document.getElementById('region-select');
            select.innerHTML = '<option value="">Select a region</option>';

            regions.forEach(r => {
                const opt = new Option(r, r);
                select.add(opt);
            });
        } catch (err) {
            document.getElementById('region-select').innerHTML = '<option value="">Failed to load regions</option>';
            displayMessage('Failed to load regions. Check server log.', 'error');
            console.error(err);
        }
    }

    /**
     * Autofills the User ID from sessionStorage and sets the hidden input.
     */
    function autofillUserId() {
        const userDetailsString = sessionStorage.getItem('userDetails');
        const displayElement = document.getElementById('user-id-display');
        const hiddenInputElement = document.getElementById('id-hidden');
        
        displayElement.classList.remove('loading');

        if (userDetailsString) {
            try {
                const userDetails = JSON.parse(userDetailsString);
                // Assuming 'id1' is the key for the user ID in the stored JSON
                const userId = userDetails.id1; 

                if (userId !== undefined && userId !== null) {
                    displayElement.textContent = `ID: ${userId}`;
                    displayElement.classList.add('success');
                    hiddenInputElement.value = userId; // Set the value for form submission
                } else {
                    displayElement.textContent = 'Error: User ID (id1) is missing from session data.';
                    displayElement.classList.add('error');
                    displayMessage('Authentication error: User ID not found.', 'error');
                }
            } catch (e) {
                displayElement.textContent = 'Error: Session data corrupted.';
                displayElement.classList.add('error');
                displayMessage('Client storage error: Data corrupted.', 'error');
            }
        } else {
            displayElement.textContent = 'Error: Not logged in.';
            displayElement.classList.add('error');
            // Redirect the user if session is missing, as a safety measure
            if (window.location.pathname !== '/') {
                 window.location.href = '/'; 
            }
        }
    }

    // Initialize the form
    window.addEventListener('load', () => {
        autofillUserId();
        loadItems();
        loadRegions();
    });
</script>

</body>
</html>